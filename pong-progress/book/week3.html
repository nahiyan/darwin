<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Week 3 - CSE498R Extended Work</title>
        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="week1.html"><strong aria-hidden="true">1.</strong> Week 1</a></li><li class="chapter-item expanded "><a href="week2.html"><strong aria-hidden="true">2.</strong> Week 2</a></li><li class="chapter-item expanded "><a href="week3.html" class="active"><strong aria-hidden="true">3.</strong> Week 3</a></li><li class="chapter-item expanded "><a href="week4.html"><strong aria-hidden="true">4.</strong> Week 4</a></li><li class="chapter-item expanded "><a href="final-report.html"><strong aria-hidden="true">5.</strong> Final Report</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">CSE498R Extended Work</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="week-3-progress"><a class="header" href="#week-3-progress">Week 3 Progress</a></h1>
<h2 id="goal"><a class="header" href="#goal">Goal</a></h2>
<p>Integrate the NEAT algorithm module, along with all other required modules of Darwin, into the extension. The extension needs to handle the evaluation of the genomes, calculating fitness values at the end of every generation, and connecting each player instance with its respective phenotype.</p>
<h2 id="connecting-the-library-with-godot"><a class="header" href="#connecting-the-library-with-godot">Connecting the Library with Godot</a></h2>
<p>The extension, Pong, uses the game framework, Godot, as its base. As a result, for connecting the NEAT algorithm's module, which is a library, to Godot, GDNative has to be used. GDNative is a mechanism for connecting the library with the game framework, Godot.</p>
<p>To do so, the library, written in C++ and comprises the API built in the previous week, has to be linked with godot-cpp, a C++ library containing everything required to let Godot load and use it.</p>
<p>Once connected, the library and its functions can be accessed through GDScript, as with any other GDScript-based function.</p>
<h2 id="controlling-the-paddles"><a class="header" href="#controlling-the-paddles">Controlling the Paddles</a></h2>
<pre><code class="language-python">func _process(delta: float) -&gt; void:
    var extents: Vector2 = ($CollisionShape2D.shape as RectangleShape2D).extents

    var ball_radius: float = (ball.get_node(&quot;CollisionShape2D&quot;).shape as CircleShape2D).radius
    var horizontal_distance: float = position.x - ball.position.x
    var vertical_distance: float = abs(position.y - extents.y - ball.position.y - ball_radius)

    var evaluation = neat.evaluate(id, ball.harmful, horizontal_distance, vertical_distance)
    var _collision: KinematicCollision2D = move_and_collide(
        evaluation * Vector2(1000, 0) * delta
    )
</code></pre>
<p>Each paddle is controlled every frame/step of the game framework by the respective neural network. The vertical and horizontal distance, along with the type of the ball, is fed into the neural network through its input layer.</p>
<p>The output is simply a value ranging from -1 to 1 (inclusive) that is used to determine the horizontal velocity of the paddle.</p>
<p><code>neat::evaluate</code> belongs to the NEAT algorithm module, which plays the role of evaluating the input parameters using the neural network.</p>
<p>This is how it's handled by the C++ library:</p>
<pre><code class="language-cpp">double evaluate(int id, bool harmfulBall, float horizontalDistance, float verticalDistance)
{
    try {
        vector&lt;double&gt; inputs, outputs(1, 0.0);
        inputs.push_back(harmfulBall);
        inputs.push_back(horizontalDistance);
        inputs.push_back(verticalDistance);
        neuralNetworks[id].evaluate(inputs, outputs);

        return outputs[0];
    } catch (...) {
        Godot::print(&quot;Error occurred while trying to evaluate.&quot;);

        return 0;
    }
}
</code></pre>
<h2 id="calculating-the-fitness-of-each-genome"><a class="header" href="#calculating-the-fitness-of-each-genome">Calculating the Fitness of Each Genome</a></h2>
<p>Whenever the ball hits a paddle or the bottom boundary, the fitness values are updated for the genomes of each paddle.</p>
<ul>
<li>
<p>Each genome is rewarded for its horizontal distance to the ball, depending on whether the ball is harmful or harmless.</p>
</li>
<li>
<p>A harmless ball when hit successfully by a paddle is rewarded, whereas hitting a harmful ball penalizes the paddle that hit it.</p>
</li>
</ul>
<p>This is how the fitness values are handled for the current population to evolve to the next:</p>
<pre><code class="language-python">func next_generation() -&gt; void:
    ball.cycles_count = 0
    reset_ball()

    for group in population:
        var score: float = 0
        for member in group.members:
            score += member.fitness

        max_fitness = max(score, max_fitness)

    generation_id += 1
    hud.set_generation(generation_id)
    hud.set_max_fitness(max_fitness)

    # Finalize the fitness, reset fitness and position
    for group in population:
        var score: float = 0
        for member in group.members:
            score += member.fitness
            member.fitness = 0

        if group.members.size() &gt; 0:
            neat.set_fitness(group.members[0].id, score)

    neat.next_generation()

    # Add dead paddles to the scene
    revive_dead_paddles()
</code></pre>
<h2 id="connecting-the-phenotypes-with-the-paddles"><a class="header" href="#connecting-the-phenotypes-with-the-paddles">Connecting the Phenotypes With the Paddles</a></h2>
<p>Each paddle instance is going to have an ID representing it, allocated during the beginning of the evolution session. This is going to be used by the library for identifying the genome to retrieve its phenotype, evaluate it, and register its fitness value.</p>
<p>The genomes and their associated neural networks (phenotypes) are stored in the library in ordered lists:</p>
<pre><code class="language-cpp">shared_ptr&lt;neat::pool&gt; pool;
vector&lt;neat::genome*&gt; genomes;
vector&lt;ann::neuralnet&gt; neuralNetworks; 
</code></pre>
<p>This is how the list is populated:</p>
<pre><code class="language-cpp">void update()
{
    genomes.clear();
    neuralNetworks.clear();

    auto genomeSpeciePairs = pool-&gt;get_genomes();
    for (auto pair : genomeSpeciePairs) {
        genomes.push_back(pair.second);

        ann::neuralnet neuralNetwork;
        neuralNetwork.from_genome(*pair.second);
        neuralNetworks.push_back(neuralNetwork);
    }
}
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="week2.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="week4.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="week2.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="week4.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
